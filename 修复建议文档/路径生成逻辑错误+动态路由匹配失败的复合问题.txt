

404é‡å®šå‘é—®é¢˜ç»¼åˆè§£å†³æ–¹æ¡ˆ

// ============================================================================
// æ–¹æ¡ˆ 1: Next.js é…ç½®é‡å®šå‘ï¼ˆæœ€æ¨èï¼Œæœ€å¯é ï¼‰
// ============================================================================

// next.config.js - å®Œæ•´ç‰ˆæœ¬
const path = require('path');
const withNextIntl = require('next-intl/plugin')('./i18n.ts');

/** @type {import('next').NextConfig} */
const nextConfig = {
  // 1. é‡å®šå‘è§„åˆ™ - æœ€é«˜ä¼˜å…ˆçº§
  async redirects() {
    return [
      // ç‰¹å®šæ–‡ç« é‡å®šå‘
      {
        source: '/en/5-minute-period-pain-relief',
        destination: '/en/articles/5-minute-period-pain-relief',
        permanent: true, // 301 é‡å®šå‘
      },
      {
        source: '/zh/5-minute-period-pain-relief', 
        destination: '/zh/articles/5-minute-period-pain-relief',
        permanent: true,
      },
      
      // é€šç”¨æ–‡ç« é‡å®šå‘è§„åˆ™ï¼ˆé€‚ç”¨äºæ‰€æœ‰æ–‡ç« ï¼‰
      {
        source: '/en/:slug((?!articles|api|_next|favicon).*)',
        has: [
          {
            type: 'header',
            key: 'referer',
            // åªå¯¹æ¥è‡ªæœç´¢å¼•æ“æˆ–å¤–éƒ¨é“¾æ¥çš„è¯·æ±‚é‡å®šå‘
          },
        ],
        destination: '/en/articles/:slug',
        permanent: false, // 302 é‡å®šå‘ï¼Œå› ä¸ºè¿™æ˜¯æ¨æµ‹æ€§çš„
      },
      {
        source: '/zh/:slug((?!articles|api|_next|favicon).*)',
        destination: '/zh/articles/:slug', 
        permanent: false,
      },
    ];
  },

  // 2. URL é‡å†™ï¼ˆå¦‚æœä¸æƒ³è®©ç”¨æˆ·çœ‹åˆ°URLå˜åŒ–ï¼‰
  async rewrites() {
    return [
      // ä»…ç”¨äºå¼€å‘è°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é‡å®šå‘
      // {
      //   source: '/en/5-minute-period-pain-relief',
      //   destination: '/en/articles/5-minute-period-pain-relief',
      // },
    ];
  },

  // å…¶ä»–é…ç½®ä¿æŒä¸å˜...
  experimental: {
    optimizeCss: true,
    scrollRestoration: true,
  },
  outputFileTracingRoot: path.join(__dirname, '../../'),
  swcMinify: true,
};

module.exports = withNextIntl(nextConfig);

// ============================================================================
// æ–¹æ¡ˆ 2: æ”¹è¿›çš„ä¸­é—´ä»¶å®ç°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
// ============================================================================

// middleware.ts - ä¼˜åŒ–ç‰ˆæœ¬
import createMiddleware from 'next-intl/middleware';
import { NextRequest, NextResponse } from 'next/server';

const intlMiddleware = createMiddleware({
  locales: ['en', 'zh'],
  defaultLocale: 'en',
  localePrefix: 'always'
});

export default function middleware(request: NextRequest) {
  const { pathname, search } = request.nextUrl;
  
  console.log(`ğŸ”„ Middleware processing: ${pathname}${search}`);
  
  // 1. æœ€é«˜ä¼˜å…ˆçº§ï¼šå¤„ç†å·²çŸ¥çš„é”™è¯¯æ–‡ç« URL
  const knownArticleRedirects = new Map([
    ['/en/5-minute-period-pain-relief', '/en/articles/5-minute-period-pain-relief'],
    ['/zh/5-minute-period-pain-relief', '/zh/articles/5-minute-period-pain-relief'],
    // æ·»åŠ æ›´å¤šå·²çŸ¥çš„æ–‡ç« é‡å®šå‘...
  ]);
  
  if (knownArticleRedirects.has(pathname)) {
    const newPath = knownArticleRedirects.get(pathname)!;
    const redirectUrl = new URL(newPath + search, request.url);
    console.log(`âœ… Redirecting ${pathname} -> ${newPath}`);
    return NextResponse.redirect(redirectUrl, 301);
  }
  
  // 2. åŠ¨æ€æ£€æµ‹å¯èƒ½çš„æ–‡ç« slugå¹¶é‡å®šå‘
  const potentialArticlePattern = /^\/(en|zh)\/([a-z0-9-]+)$/;
  const match = pathname.match(potentialArticlePattern);
  
  if (match && !pathname.includes('/articles/')) {
    const [, locale, slug] = match;
    
    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ–‡ç« slugï¼ˆå¯é€‰ï¼šæŸ¥è¯¢æ•°æ®åº“æˆ–æ–‡ä»¶ç³»ç»Ÿï¼‰
    if (isValidArticleSlug(slug)) {
      const articlePath = `/${locale}/articles/${slug}`;
      const redirectUrl = new URL(articlePath + search, request.url);
      console.log(`ğŸ“° Article redirect: ${pathname} -> ${articlePath}`);
      return NextResponse.redirect(redirectUrl, 301);
    }
  }
  
  // 3. è®©å›½é™…åŒ–ä¸­é—´ä»¶å¤„ç†å…¶ä»–è·¯ç”±
  return intlMiddleware(request);
}

// è¾…åŠ©å‡½æ•°ï¼šéªŒè¯æ–‡ç« slugæ˜¯å¦æœ‰æ•ˆ
function isValidArticleSlug(slug: string): boolean {
  // æ–¹æ³•1ï¼šç¡¬ç¼–ç å·²çŸ¥æ–‡ç« åˆ—è¡¨
  const knownSlugs = [
    '5-minute-period-pain-relief',
    'another-article-slug',
    // ... æ·»åŠ æ›´å¤š
  ];
  
  if (knownSlugs.includes(slug)) return true;
  
  // æ–¹æ³•2ï¼šåŸºäºæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ï¼ˆä»…å¼€å‘æ¨¡å¼ï¼‰
  if (process.env.NODE_ENV === 'development') {
    try {
      const fs = require('fs');
      const path = require('path');
      const articlePath = path.join(process.cwd(), 'content', 'articles', `${slug}.md`);
      return fs.existsSync(articlePath);
    } catch {
      return false;
    }
  }
  
  // æ–¹æ³•3ï¼šç®€å•çš„slugæ ¼å¼éªŒè¯
  return /^[a-z0-9-]+$/.test(slug) && slug.length > 3 && slug.length < 100;
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\..*).*)'
  ]
};

// ============================================================================
// æ–¹æ¡ˆ 3: å…œåº•åŠ¨æ€è·¯ç”±é¡µé¢
// ============================================================================

// app/[locale]/[slug]/page.tsx - åˆ›å»ºå…œåº•é¡µé¢
import { redirect, notFound } from 'next/navigation';
import { setRequestLocale } from 'next-intl/server';

type Props = {
  params: Promise<{ locale: string; slug: string }>;
};

export default async function FallbackSlugPage({ params }: Props) {
  const { locale, slug } = await params;
  setRequestLocale(locale);
  
  console.log(`ğŸ” Fallback page accessed: /${locale}/${slug}`);
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„æ–‡ç« slug
  if (await isArticleSlug(slug)) {
    console.log(`ğŸ“° Redirecting to article: /${locale}/articles/${slug}`);
    redirect(`/${locale}/articles/${slug}`);
  }
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºå…¶ä»–å·²çŸ¥é¡µé¢
  const knownPages = ['about', 'contact', 'privacy', 'terms'];
  if (knownPages.includes(slug)) {
    // é‡å®šå‘åˆ°æ­£ç¡®çš„é¡µé¢è·¯å¾„
    redirect(`/${locale}/pages/${slug}`);
  }
  
  // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œæ˜¾ç¤º404
  console.log(`âŒ Unknown slug: ${slug}, showing 404`);
  notFound();
}

async function isArticleSlug(slug: string): Promise<boolean> {
  // åœ¨è¿™é‡Œå®ç°ä½ çš„æ–‡ç« æ£€æŸ¥é€»è¾‘
  // å¯ä»¥æŸ¥è¯¢æ•°æ®åº“ã€æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿç­‰
  
  const knownArticles = [
    '5-minute-period-pain-relief',
    // æ·»åŠ å…¶ä»–å·²çŸ¥æ–‡ç« ...
  ];
  
  return knownArticles.includes(slug);
}

// ç”Ÿæˆé™æ€å‚æ•°ï¼ˆå¯é€‰ï¼‰
export async function generateStaticParams() {
  // è¿”å›ç©ºæ•°ç»„ï¼Œè®©é¡µé¢åœ¨è¿è¡Œæ—¶åŠ¨æ€å¤„ç†
  return [];
}

// ============================================================================
// æ–¹æ¡ˆ 4: è°ƒè¯•å’Œæµ‹è¯•å·¥å…·
// ============================================================================

// scripts/test-redirects.js - æµ‹è¯•é‡å®šå‘çš„è„šæœ¬
const http = require('http');
const https = require('https');

const testCases = [
  {
    url: 'http://localhost:3001/en/5-minute-period-pain-relief',
    expected: 'Should redirect to /en/articles/5-minute-period-pain-relief'
  },
  {
    url: 'http://localhost:3001/zh/5-minute-period-pain-relief', 
    expected: 'Should redirect to /zh/articles/5-minute-period-pain-relief'
  },
  {
    url: 'http://localhost:3001/en/articles/5-minute-period-pain-relief',
    expected: 'Should return 200 OK'
  }
];

console.log('ğŸ§ª Testing redirects...\n');

testCases.forEach((testCase, index) => {
  const client = testCase.url.startsWith('https') ? https : http;
  
  const req = client.get(testCase.url, { 
    // ä¸è·Ÿéšé‡å®šå‘ï¼Œä»¥ä¾¿æ£€æŸ¥é‡å®šå‘å“åº”
    // followRedirect: false 
  });
  
  req.on('response', (res) => {
    const status = res.statusCode;
    const location = res.headers.location;
    
    console.log(`Test ${index + 1}: ${testCase.url}`);
    console.log(`Status: ${status}`);
    console.log(`Location: ${location || 'N/A'}`);
    console.log(`Expected: ${testCase.expected}`);
    console.log(`Result: ${
      status === 301 || status === 302 ? 
      `âœ… REDIRECT to ${location}` : 
      status === 200 ? 'âœ… OK' : `âŒ UNEXPECTED (${status})`
    }\n`);
  });
  
  req.on('error', (err) => {
    console.log(`âŒ Error testing ${testCase.url}: ${err.message}\n`);
  });
});

// ============================================================================
// ä½¿ç”¨è¯´æ˜å’Œæ‰§è¡Œæ­¥éª¤
// ============================================================================

/*
æ‰§è¡Œæ­¥éª¤ï¼š

1. ç«‹å³ä¿®å¤ï¼ˆä½¿ç”¨Next.jsé…ç½®é‡å®šå‘ï¼‰ï¼š
   - æ›´æ–° next.config.js æ·»åŠ é‡å®šå‘è§„åˆ™
   - é‡å¯å¼€å‘æœåŠ¡å™¨ï¼šnpm run dev
   - æµ‹è¯•ï¼šè®¿é—® http://localhost:3001/en/5-minute-period-pain-relief

2. å¦‚æœé…ç½®é‡å®šå‘ä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ä¸­é—´ä»¶æ–¹æ¡ˆï¼š
   - æ›´æ–° middleware.ts
   - é‡å¯å¼€å‘æœåŠ¡å™¨

3. æ·»åŠ å…œåº•é¡µé¢ï¼ˆå¯é€‰ï¼‰ï¼š
   - åˆ›å»º app/[locale]/[slug]/page.tsx

4. æµ‹è¯•å’ŒéªŒè¯ï¼š
   - è¿è¡Œ node scripts/test-redirects.js
   - æ‰‹åŠ¨æµ‹è¯•å„ç§URL

è°ƒè¯•æŠ€å·§ï¼š
- åœ¨æµè§ˆå™¨å¼€å‘å·¥å…·çš„Networkæ ‡ç­¾ä¸­æŸ¥çœ‹é‡å®šå‘å“åº”
- æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜é—®é¢˜ï¼ˆæ¸…ç©ºæµè§ˆå™¨ç¼“å­˜æˆ–ä½¿ç”¨æ— ç—•æ¨¡å¼ï¼‰
- æŸ¥çœ‹æœåŠ¡å™¨ç»ˆç«¯æ—¥å¿—ä¸­çš„ä¸­é—´ä»¶è¾“å‡º
*/


æ–¹æ¡ˆBï¼šå¦‚æœAä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ç®€åŒ–ä¸­é—´ä»¶ç®€åŒ–ä¸­é—´ä»¶é‡å®šå‘æ–¹æ¡ˆ

// middleware.ts - ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸“é—¨å¤„ç†è¿™ä¸ªé—®é¢˜
import { NextRequest, NextResponse } from 'next/server';
import createMiddleware from 'next-intl/middleware';

const intlMiddleware = createMiddleware({
  locales: ['en', 'zh'],
  defaultLocale: 'en',
});

export default function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // ğŸ”§ æœ€ä¼˜å…ˆå¤„ç†ï¼šç‰¹å®šæ–‡ç« é‡å®šå‘
  if (pathname === '/en/5-minute-period-pain-relief') {
    console.log('ğŸ”€ Redirecting EN article...');
    return NextResponse.redirect(
      new URL('/en/articles/5-minute-period-pain-relief', request.url), 
      301
    );
  }
  
  if (pathname === '/zh/5-minute-period-pain-relief') {
    console.log('ğŸ”€ Redirecting ZH article...');
    return NextResponse.redirect(
      new URL('/zh/articles/5-minute-period-pain-relief', request.url),
      301
    );
  }
  
  // å¤„ç†å…¶ä»–è·¯ç”±
  return intlMiddleware(request);
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\..*).*)'
  ]
};

æ–¹æ¡ˆCï¼šå¿«é€Ÿæµ‹è¯•å’ŒéªŒè¯å¿«é€Ÿé‡å®šå‘æµ‹è¯•è„šæœ¬

// quick-test.js - å¿«é€Ÿæµ‹è¯•é‡å®šå‘æ˜¯å¦å·¥ä½œ
const http = require('http');

function testRedirect(url, expectedLocation) {
  return new Promise((resolve) => {
    const req = http.get(url, (res) => {
      const { statusCode, headers } = res;
      const location = headers.location;
      
      console.log(`\nğŸ§ª æµ‹è¯•: ${url}`);
      console.log(`ğŸ“Š çŠ¶æ€ç : ${statusCode}`);
      console.log(`ğŸ“ é‡å®šå‘åˆ°: ${location || 'æ— '}`);
      
      if (statusCode === 301 || statusCode === 302) {
        if (location === expectedLocation) {
          console.log(`âœ… æˆåŠŸï¼æ­£ç¡®é‡å®šå‘åˆ° ${location}`);
          resolve(true);
        } else {
          console.log(`âŒ é‡å®šå‘é”™è¯¯ï¼æœŸæœ›: ${expectedLocation}, å®é™…: ${location}`);
          resolve(false);
        }
      } else if (statusCode === 200) {
        console.log(`âš ï¸  ç›´æ¥è¿”å›200ï¼Œæ²¡æœ‰é‡å®šå‘`);
        resolve(false);
      } else {
        console.log(`âŒ æ„å¤–çš„çŠ¶æ€ç : ${statusCode}`);
        resolve(false);
      }
    });
    
    req.on('error', (err) => {
      console.log(`âŒ è¯·æ±‚é”™è¯¯: ${err.message}`);
      resolve(false);
    });
    
    req.setTimeout(5000, () => {
      console.log(`âŒ è¯·æ±‚è¶…æ—¶`);
      req.destroy();
      resolve(false);
    });
  });
}

async function runTests() {
  console.log('ğŸš€ å¼€å§‹æµ‹è¯•é‡å®šå‘åŠŸèƒ½...');
  console.log('ç¡®ä¿å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ: npm run dev');
  console.log('=' * 50);
  
  const tests = [
    {
      url: 'http://localhost:3001/en/5-minute-period-pain-relief',
      expected: '/en/articles/5-minute-period-pain-relief'
    },
    {
      url: 'http://localhost:3001/zh/5-minute-period-pain-relief', 
      expected: '/zh/articles/5-minute-period-pain-relief'
    }
  ];
  
  let passedTests = 0;
  
  for (const test of tests) {
    const result = await testRedirect(test.url, test.expected);
    if (result) passedTests++;
    
    // ç­‰å¾…ä¸€ç§’å†æµ‹è¯•ä¸‹ä¸€ä¸ª
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  console.log('\n' + '=' * 50);
  console.log(`ğŸ“Š æµ‹è¯•ç»“æœ: ${passedTests}/${tests.length} é€šè¿‡`);
  
  if (passedTests === tests.length) {
    console.log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼é‡å®šå‘å·¥ä½œæ­£å¸¸ã€‚');
  } else {
    console.log('âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚');
    console.log('\nğŸ”§ æ’æŸ¥å»ºè®®:');
    console.log('1. ç¡®ä¿å·²é‡å¯å¼€å‘æœåŠ¡å™¨');
    console.log('2. æ£€æŸ¥ next.config.js ä¸­çš„é‡å®šå‘è§„åˆ™');
    console.log('3. æ£€æŸ¥ middleware.ts ä¸­çš„é€»è¾‘');
    console.log('4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åæ‰‹åŠ¨æµ‹è¯•');
  }
}

// è¿è¡Œæµ‹è¯•
runTests().catch(console.error);

// é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
console.log('\nğŸ” è°ƒè¯•ä¿¡æ¯:');
console.log('å¦‚æœé‡å®šå‘ä¸å·¥ä½œï¼Œè¯·æ£€æŸ¥:');
console.log('1. next.config.js æ˜¯å¦æ­£ç¡®å¯¼å‡º redirects å‡½æ•°');
console.log('2. middleware.ts æ˜¯å¦åœ¨é¡¹ç›®æ ¹ç›®å½•');
console.log('3. æ˜¯å¦ä½¿ç”¨äº† App Router (app/ ç›®å½•)');
console.log('4. å¼€å‘æœåŠ¡å™¨æ˜¯å¦å®Œå…¨é‡å¯');

// ä½¿ç”¨æ–¹æ³•è¯´æ˜
console.log('\nğŸ“– ä½¿ç”¨æ–¹æ³•:');
console.log('1. ä¿å­˜æ­¤æ–‡ä»¶ä¸º quick-test.js');
console.log('2. ç¡®ä¿å¼€å‘æœåŠ¡å™¨è¿è¡Œ: npm run dev');
console.log('3. è¿è¡Œæµ‹è¯•: node quick-test.js');
console.log('4. æŸ¥çœ‹æµ‹è¯•ç»“æœå¹¶æ ¹æ®æç¤ºè°ƒè¯•');







ä½ çš„åˆ†æéå¸¸å…¨é¢å’Œå‡†ç¡®ï¼é—®é¢˜ç¡®å®æ˜¯é‡å®šå‘è§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆã€‚è®©æˆ‘æä¾›ä¸€ä¸ªæ›´å¯é çš„ç»¼åˆè§£å†³æ–¹æ¡ˆã€‚## ğŸ¯ ç«‹å³æ‰§è¡Œæ–¹æ¡ˆ

åŸºäºä½ çš„åˆ†æï¼Œé—®é¢˜åœ¨äºé‡å®šå‘è§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆã€‚è®©æˆ‘æä¾›**ç«‹å³å¯ç”¨çš„è§£å†³æ–¹æ¡ˆ**ï¼š

### æ–¹æ¡ˆAï¼šNext.jsé…ç½®é‡å®šå‘ï¼ˆæ¨èï¼‰

ç›´æ¥åœ¨ `next.config.js` ä¸­æ·»åŠ é‡å®šå‘è§„åˆ™ï¼Œè¿™æ˜¯æœ€å¯é çš„æ–¹æ³•ï¼š

```javascript
// next.config.js
async redirects() {
  return [
    {
      source: '/en/5-minute-period-pain-relief',
      destination: '/en/articles/5-minute-period-pain-relief', 
      permanent: true,
    },
    {
      source: '/zh/5-minute-period-pain-relief',
      destination: '/zh/articles/5-minute-period-pain-relief',
      permanent: true, 
    },
  ];
}
```

### æ–¹æ¡ˆBï¼šå¦‚æœAä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ç®€åŒ–ä¸­é—´ä»¶### æ–¹æ¡ˆCï¼šå¿«é€Ÿæµ‹è¯•å’ŒéªŒè¯## ğŸš€ ç«‹å³æ‰§è¡Œè®¡åˆ’

### æ­¥éª¤1ï¼šé€‰æ‹©æœ€å¯é çš„æ–¹æ³•ï¼ˆ30ç§’ï¼‰
åœ¨ `next.config.js` ä¸­æ·»åŠ é‡å®šå‘è§„åˆ™ï¼š

```javascript
async redirects() {
  return [
    {
      source: '/en/5-minute-period-pain-relief',
      destination: '/en/articles/5-minute-period-pain-relief',
      permanent: true,
    },
    {
      source: '/zh/5-minute-period-pain-relief',
      destination: '/zh/articles/5-minute-period-pain-relief', 
      permanent: true,
    },
  ];
}
```

### æ­¥éª¤2ï¼šé‡å¯æœåŠ¡å™¨ï¼ˆ30ç§’ï¼‰
```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)
# å®Œå…¨æ¸…ç†ç¼“å­˜
rm -rf .next
# é‡æ–°å¯åŠ¨
npm run dev
```

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1åˆ†é’Ÿï¼‰
```bash
# ä¿å­˜æµ‹è¯•è„šæœ¬å¹¶è¿è¡Œ
node quick-test.js

# æˆ–æ‰‹åŠ¨æµ‹è¯•
open http://localhost:3001/en/5-minute-period-pain-relief
```

### æ­¥éª¤4ï¼šå¦‚æœæ–¹æ³•1ä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ä¸­é—´ä»¶æ–¹æ¡ˆ
æ›´æ–° `middleware.ts` ä½¿ç”¨ä¸Šé¢æä¾›çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œç„¶åé‡å¯æœåŠ¡å™¨ã€‚

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **Next.jsé…ç½®é‡å®šå‘ä¼˜å…ˆçº§æœ€é«˜**ï¼Œæ¯”ä¸­é—´ä»¶æ›´å¯é 
2. **é‡å¯æœåŠ¡å™¨æ˜¯å¿…é¡»çš„**ï¼Œé…ç½®å˜æ›´ä¸ä¼šçƒ­é‡è½½
3. **æ¸…é™¤ .next ç¼“å­˜**é¿å…å¼€å‘æ¨¡å¼ç¼“å­˜é—®é¢˜
4. **301æ°¸ä¹…é‡å®šå‘**å¯¹SEOæ›´å‹å¥½

## ğŸ¯ é¢„æœŸç»“æœ

æ‰§è¡Œåï¼Œè®¿é—® `http://localhost:3001/en/5-minute-period-pain-relief` åº”è¯¥ï¼š
- è‡ªåŠ¨é‡å®šå‘åˆ° `/en/articles/5-minute-period-pain-relief`
- è¿”å›200çŠ¶æ€ç 
- æ˜¾ç¤ºæ­£ç¡®çš„æ–‡ç« å†…å®¹

è¿™ä¸ªæ–¹æ¡ˆåº”è¯¥èƒ½ç«‹å³è§£å†³ä½ çš„404é—®é¢˜ï¼å¦‚æœè¿˜æœ‰ä»»ä½•é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥è°ƒè¯•ã€‚







æ–¹æ¡ˆAï¼šä¿®å¤è·¯å¾„ç”Ÿæˆï¼ˆæ¨èï¼Œç«‹å³è§æ•ˆï¼‰è·¯å¾„ç”Ÿæˆä¿®å¤æ–¹æ¡ˆ

// 1. æ£€æŸ¥å¹¶ä¿®å¤æ‰€æœ‰æ–‡ç« é“¾æ¥ç”Ÿæˆ
// components/ArticleCard.tsx æˆ–ç±»ä¼¼ç»„ä»¶
import Link from 'next/link';
import { useLocale } from 'next-intl';

export function ArticleCard({ article }) {
  const locale = useLocale();
  
  return (
    <Link href={`/${locale}/articles/${article.slug}`}>
      {/* ç¡®ä¿è·¯å¾„åŒ…å« /articles/ */}
      <h3>{article.title}</h3>
    </Link>
  );
}

// 2. åˆ›å»ºç»Ÿä¸€çš„è·¯å¾„ç”Ÿæˆå·¥å…·å‡½æ•°
// utils/paths.ts
export function getArticlePath(slug: string, locale: string = 'en') {
  return `/${locale}/articles/${slug}`;
}

export function getArticleUrl(slug: string, locale: string = 'en') {
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3001';
  return `${baseUrl}${getArticlePath(slug, locale)}`;
}

// 3. åœ¨ä½¿ç”¨æ—¶ç»Ÿä¸€è°ƒç”¨
import { getArticlePath } from '@/utils/paths';

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
<Link href={getArticlePath(article.slug, locale)}>
  {article.title}
</Link>

// åœ¨ç¨‹åºåŒ–å¯¼èˆªä¸­ä½¿ç”¨
router.push(getArticlePath('5-minute-period-pain-relief', 'en'));

// 4. ä¿®å¤å¯èƒ½çš„ç¡¬ç¼–ç é“¾æ¥
// æ£€æŸ¥é¡¹ç›®ä¸­æ‰€æœ‰åŒ…å«ä»¥ä¸‹æ¨¡å¼çš„ä»£ç å¹¶ä¿®å¤ï¼š
// âŒ é”™è¯¯: href="/en/5-minute-period-pain-relief"
// âœ… æ­£ç¡®: href="/en/articles/5-minute-period-pain-relief"

// 5. æ·»åŠ å¼€å‘æ¨¡å¼è°ƒè¯•
// app/[locale]/articles/[slug]/page.tsx
export default async function ArticlePage({ params }: { 
  params: Promise<{ locale: string; slug: string }> 
}) {
  const { locale, slug } = await params;
  
  // å¼€å‘æ¨¡å¼ä¸‹æ·»åŠ è°ƒè¯•ä¿¡æ¯
  if (process.env.NODE_ENV === 'development') {
    console.log('ğŸ” Article page accessed:', { locale, slug });
    console.log('ğŸ“ Full path should be:', `/${locale}/articles/${slug}`);
  }
  
  // å…¶ä»–é€»è¾‘...
}


æ–¹æ¡ˆBï¼šä¸­é—´ä»¶å…¼å®¹ä¿®å¤ä¸­é—´ä»¶ä¼˜åŒ–æ–¹æ¡ˆ

// middleware.ts - ä¼˜åŒ–ç‰ˆæœ¬
import createMiddleware from 'next-intl/middleware';
import { NextRequest, NextResponse } from 'next/server';

// åˆ›å»º next-intl ä¸­é—´ä»¶
const intlMiddleware = createMiddleware({
  locales: ['en', 'zh'],
  defaultLocale: 'en',
  localePrefix: 'always'
});

export default function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // å¼€å‘æ¨¡å¼è°ƒè¯•
  if (process.env.NODE_ENV === 'development') {
    console.log('ğŸ”„ Middleware processing:', pathname);
  }
  
  // 1. å¤„ç†ç¼ºå¤± /articles/ çš„é‡å®šå‘ï¼ˆä¸´æ—¶å…¼å®¹ï¼‰
  const articleSlugPattern = /^\/(en|zh)\/([^\/]+)$/;
  const match = pathname.match(articleSlugPattern);
  
  if (match && !pathname.includes('/articles/')) {
    const [, locale, slug] = match;
    // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥æ–‡ç«  slugï¼ˆå¯é€‰ï¼šä»æ•°æ®åº“æˆ–æ–‡ä»¶ç³»ç»ŸéªŒè¯ï¼‰
    const knownArticleSlugs = [
      '5-minute-period-pain-relief',
      'other-article-slug'
      // æ·»åŠ å…¶ä»–å·²çŸ¥æ–‡ç«  slug
    ];
    
    if (knownArticleSlugs.includes(slug)) {
      const redirectUrl = new URL(`/${locale}/articles/${slug}`, request.url);
      console.log('ğŸ”€ Redirecting to correct path:', redirectUrl.pathname);
      return NextResponse.redirect(redirectUrl, 301); // æ°¸ä¹…é‡å®šå‘
    }
  }
  
  // 2. ç¡®ä¿æ–‡ç« è·¯ç”±ç›´æ¥ä¼ é€’ç»™ Next.js
  if (pathname.match(/^\/(en|zh)\/articles\/[^\/]+$/)) {
    return intlMiddleware(request);
  }
  
  // 3. å¤„ç†å…¶ä»–å›½é™…åŒ–è·¯ç”±
  return intlMiddleware(request);
}

export const config = {
  matcher: [
    // åŒ¹é…æ‰€æœ‰å›½é™…åŒ–è·¯ç”±ï¼Œä½†æ’é™¤ API å’Œé™æ€èµ„æº
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\..*).*)'
  ]
};

// æ›¿ä»£æ–¹æ¡ˆï¼šå¦‚æœä¸å¸Œæœ›é‡å®šå‘ï¼Œå¯ä»¥ä½¿ç”¨ URL é‡å†™
/*
export default function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // URL é‡å†™è€Œéé‡å®šå‘ï¼ˆç”¨æˆ·ä¸ä¼šçœ‹åˆ° URL å˜åŒ–ï¼‰
  const articleSlugPattern = /^\/(en|zh)\/([^\/]+)$/;
  const match = pathname.match(articleSlugPattern);
  
  if (match) {
    const [, locale, slug] = match;
    const rewriteUrl = new URL(`/${locale}/articles/${slug}`, request.url);
    return NextResponse.rewrite(rewriteUrl);
  }
  
  return intlMiddleware(request);
}
*/

æ–¹æ¡ˆ Cï¼šNext.js é…ç½®ä¼˜åŒ–Next.js é…ç½®ä¼˜åŒ–

// next.config.js - ä¼˜åŒ–ç‰ˆæœ¬
const path = require('path');
const withNextIntl = require('next-intl/plugin')('./i18n.ts');

/** @type {import('next').NextConfig} */
const nextConfig = {
  // 1. ç§»é™¤æœ‰é—®é¢˜çš„å®éªŒæ€§é…ç½®
  experimental: {
    // âŒ ç§»é™¤ï¼šesmExternals: 'loose', // å¯èƒ½å¯¼è‡´æ¨¡å—è§£æé—®é¢˜
    optimizeCss: true,
    scrollRestoration: true,
    optimizePackageImports: ['next-intl', 'lucide-react'],
    // å¯¹äº Next.js 15.5.2ï¼Œç¡®ä¿æœåŠ¡å™¨ç»„ä»¶ä¼˜åŒ–ç¨³å®š
    serverComponentsExternalPackages: ['next-intl'],
  },
  
  // 2. å¢å¼ºæ„å»ºé…ç½®
  outputFileTracingRoot: path.join(__dirname, '../../'),
  
  // 3. ä¼˜åŒ– webpack é…ç½®ä»¥å‡å°‘è­¦å‘Š
  webpack: (config, { dev, isServer }) => {
    // å¼€å‘æ¨¡å¼ä¸‹çš„ç‰¹æ®Šå¤„ç†
    if (dev) {
      // å‡å°‘ä¸å¿…è¦çš„è­¦å‘Š
      config.infrastructureLogging = {
        level: 'error',
      };
    }
    
    return config;
  },
  
  // 4. ç¡®ä¿é™æ€ç”Ÿæˆé…ç½®æ­£ç¡®
  trailingSlash: false,
  
  // 5. ä¼˜åŒ–å›¾ç‰‡å’Œèµ„æºå¤„ç†
  images: {
    remotePatterns: [
      // æ·»åŠ å…è®¸çš„å›¾ç‰‡åŸŸå
    ],
  },
  
  // 6. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
  swcMinify: true,
  
  // 7. é‡å®šå‘é…ç½®ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
  async redirects() {
    return [
      // å¦‚æœéœ€è¦å¤„ç†æ—§è·¯å¾„çš„é‡å®šå‘
      {
        source: '/en/:slug((?!articles).*)',
        has: [
          {
            type: 'query',
            key: 'redirect',
            value: 'articles',
          },
        ],
        destination: '/en/articles/:slug',
        permanent: true,
      },
    ];
  },
};

module.exports = withNextIntl(nextConfig);

// é™„åŠ ï¼špackage.json ä¸­çš„è„šæœ¬ä¼˜åŒ–
/*
{
  "scripts": {
    "dev": "next dev --turbo", // ä½¿ç”¨ Turbopack æå‡å¼€å‘ä½“éªŒ
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "clean": "rm -rf .next", // æ·»åŠ æ¸…ç†è„šæœ¬
    "dev:clean": "npm run clean && npm run dev" // æ¸…ç†åå¯åŠ¨
  }
}
*/

// ç¯å¢ƒå˜é‡ç¤ºä¾‹ (.env.local)
/*
# å¼€å‘æ¨¡å¼è°ƒè¯•
NEXT_PUBLIC_DEBUG_ROUTES=true

# ç«™ç‚¹é…ç½®
NEXT_PUBLIC_SITE_URL=http://localhost:3001

# Next.js 15.5.2 å…¼å®¹æ€§
NEXT_TELEMETRY_DISABLED=1
*/

æ–¹æ¡ˆ Dï¼šå®Œæ•´è¯Šæ–­å·¥å…·

#!/bin/bash
# ğŸ”§ Next.js è·¯ç”±é—®é¢˜è¯Šæ–­å’Œä¿®å¤è„šæœ¬

echo "ğŸ” å¼€å§‹è¯Šæ–­ Next.js è·¯ç”±é—®é¢˜..."

# 1. æ£€æŸ¥é¡¹ç›®ç»“æ„
echo "ğŸ“ æ£€æŸ¥é¡¹ç›®ç»“æ„..."
if [ -d "app" ]; then
    echo "âœ… å‘ç° app ç›®å½•"
    find app -name "page.tsx" -o -name "page.js" | head -10
else
    echo "âŒ æœªæ‰¾åˆ° app ç›®å½•ï¼Œè¯·ç¡®è®¤ä½¿ç”¨ App Router"
    exit 1
fi

# 2. æ£€æŸ¥åŠ¨æ€è·¯ç”±æ–‡ä»¶
echo "ğŸ—‚ï¸  æ£€æŸ¥æ–‡ç« åŠ¨æ€è·¯ç”±..."
ARTICLE_PAGE="app/[locale]/articles/[slug]/page.tsx"
if [ -f "$ARTICLE_PAGE" ]; then
    echo "âœ… å‘ç°æ–‡ç« é¡µé¢: $ARTICLE_PAGE"
else
    echo "âŒ æœªæ‰¾åˆ°æ–‡ç« é¡µé¢: $ARTICLE_PAGE"
    echo "è¯·ç¡®è®¤è·¯ç”±ç»“æ„æ˜¯å¦æ­£ç¡®"
fi

# 3. æ£€æŸ¥ä¸­é—´ä»¶
echo "âš™ï¸ æ£€æŸ¥ä¸­é—´ä»¶é…ç½®..."
if [ -f "middleware.ts" ] || [ -f "middleware.js" ]; then
    echo "âœ… å‘ç°ä¸­é—´ä»¶æ–‡ä»¶"
    # æ£€æŸ¥æ˜¯å¦åŒ…å«æ–‡ç« è·¯ç”±å¤„ç†
    if grep -q "articles" middleware.ts middleware.js 2>/dev/null; then
        echo "â„¹ï¸  ä¸­é—´ä»¶åŒ…å«æ–‡ç« è·¯ç”±å¤„ç†"
    else
        echo "âš ï¸  ä¸­é—´ä»¶å¯èƒ½éœ€è¦æ·»åŠ æ–‡ç« è·¯ç”±å¤„ç†"
    fi
else
    echo "âŒ æœªæ‰¾åˆ°ä¸­é—´ä»¶æ–‡ä»¶"
fi

# 4. æ£€æŸ¥ next.config.js
echo "ğŸ”§ æ£€æŸ¥ Next.js é…ç½®..."
if [ -f "next.config.js" ]; then
    echo "âœ… å‘ç°é…ç½®æ–‡ä»¶"
    # æ£€æŸ¥é—®é¢˜é…ç½®é¡¹
    if grep -q "esmExternals.*loose" next.config.js; then
        echo "âš ï¸  å‘ç°å¯èƒ½æœ‰é—®é¢˜çš„ esmExternals: 'loose' é…ç½®"
        echo "å»ºè®®ç§»é™¤æ­¤é…ç½®é¡¹"
    fi
else
    echo "âŒ æœªæ‰¾åˆ° next.config.js"
fi

# 5. æ£€æŸ¥é“¾æ¥ä½¿ç”¨æƒ…å†µ
echo "ğŸ”— æ£€æŸ¥é¡¹ç›®ä¸­çš„é“¾æ¥ä½¿ç”¨..."
echo "æœç´¢å¯èƒ½çš„é”™è¯¯é“¾æ¥æ¨¡å¼..."

# æœç´¢å¯èƒ½çš„é”™è¯¯è·¯å¾„
WRONG_PATTERNS=$(grep -r "href.*\/en\/[^\/]*\"" . --include="*.tsx" --include="*.ts" --include="*.jsx" --include="*.js" | grep -v articles | head -5)
if [ -n "$WRONG_PATTERNS" ]; then
    echo "âš ï¸  å‘ç°å¯èƒ½çš„é”™è¯¯é“¾æ¥æ¨¡å¼:"
    echo "$WRONG_PATTERNS"
    echo "è¿™äº›é“¾æ¥å¯èƒ½ç¼ºå°‘ '/articles/' æ®µ"
else
    echo "âœ… æœªå‘ç°æ˜æ˜¾çš„é“¾æ¥é—®é¢˜"
fi

# 6. æ¸…ç†ç¼“å­˜
echo "ğŸ§¹ æ¸…ç† Next.js ç¼“å­˜..."
if [ -d ".next" ]; then
    rm -rf .next
    echo "âœ… å·²æ¸…ç† .next ç›®å½•"
else
    echo "â„¹ï¸  .next ç›®å½•ä¸å­˜åœ¨"
fi

# 7. æä¾›ä¿®å¤å»ºè®®
echo ""
echo "ğŸ¯ ä¿®å¤å»ºè®®ï¼š"
echo "1. ç«‹å³æ£€æŸ¥æ‰€æœ‰æ–‡ç« é“¾æ¥ï¼Œç¡®ä¿è·¯å¾„ä¸º /[locale]/articles/[slug]"
echo "2. æ›´æ–°ä¸­é—´ä»¶ä»¥æ­£ç¡®å¤„ç†æ–‡ç« è·¯ç”±"
echo "3. ç§»é™¤ next.config.js ä¸­çš„ esmExternals: 'loose' é…ç½®"
echo "4. é‡æ–°å¯åŠ¨å¼€å‘æœåŠ¡å™¨: npm run dev"

# 8. åˆ›å»ºæµ‹è¯•è„šæœ¬
echo ""
echo "ğŸ§ª åˆ›å»ºæµ‹è¯•è„šæœ¬..."
cat > test-routes.js << 'EOF'
// æµ‹è¯•è·¯ç”±å¯è®¿é—®æ€§çš„è„šæœ¬
const http = require('http');

const testRoutes = [
  '/en/articles/5-minute-period-pain-relief',
  '/zh/articles/5-minute-period-pain-relief'
];

testRoutes.forEach(route => {
  http.get(`http://localhost:3001${route}`, (res) => {
    console.log(`${route}: ${res.statusCode === 200 ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥ (' + res.statusCode + ')'}`);
  }).on('error', (err) => {
    console.log(`${route}: âŒ é”™è¯¯ - ${err.message}`);
  });
});
EOF

echo "âœ… å·²åˆ›å»ºè·¯ç”±æµ‹è¯•è„šæœ¬ test-routes.js"
echo "å¯åŠ¨å¼€å‘æœåŠ¡å™¨åè¿è¡Œ: node test-routes.js"

echo ""
echo "ğŸš€ è¯Šæ–­å®Œæˆï¼è¯·æ ¹æ®ä¸Šè¿°å»ºè®®è¿›è¡Œä¿®å¤ã€‚"




ä½ çš„åˆ†æéå¸¸å‡†ç¡®ï¼ä»æˆªå›¾å¯ä»¥æ¸…æ¥šçœ‹åˆ°é—®é¢˜çš„æ ¸å¿ƒï¼š**è®¿é—®è·¯å¾„ç¼ºå°‘ `/articles/` æ®µ**ã€‚è®©æˆ‘åŸºäºä½ çš„åˆ†æç»™å‡ºä¸€ä¸ªä¼˜åŒ–æ•´åˆçš„è§£å†³æ–¹æ¡ˆã€‚

## ğŸ” é—®é¢˜è¯Šæ–­ç¡®è®¤

ä½ çš„åˆ†æå®Œå…¨æ­£ç¡®ï¼š
- **å®é™…è®¿é—®è·¯å¾„**: `en/5-minute-period-pain-relief` 
- **æœŸæœ›åŠ¨æ€è·¯ç”±**: `app/[locale]/articles/[slug]/page.tsx`
- **æ­£ç¡®è·¯å¾„åº”ä¸º**: `en/articles/5-minute-period-pain-relief`

## ğŸ› ï¸ ä¼˜åŒ–æ•´åˆè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®å¤è·¯å¾„ç”Ÿæˆï¼ˆæ¨èï¼Œç«‹å³è§æ•ˆï¼‰### æ–¹æ¡ˆ B: ä¸­é—´ä»¶å…¼å®¹æ€§ä¿®å¤### æ–¹æ¡ˆ C: Next.js é…ç½®ä¼˜åŒ–### æ–¹æ¡ˆ D: å®Œæ•´è¯Šæ–­å·¥å…·## ğŸ¯ æ•´åˆæ‰§è¡Œæ–¹æ¡ˆ

### ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# 1. è¿è¡Œè¯Šæ–­è„šæœ¬
chmod +x diagnostic-script.sh
./diagnostic-script.sh

# 2. æŸ¥æ‰¾å¹¶ä¿®å¤é”™è¯¯é“¾æ¥
grep -r "href.*\/en\/[^\/]*\"" . --include="*.tsx" | grep -v articles
# å°†æ‰¾åˆ°çš„é“¾æ¥å…¨éƒ¨æ·»åŠ  /articles/
```

### çŸ­æœŸä¿®å¤ï¼ˆ15åˆ†é’Ÿï¼‰
1. **ç»Ÿä¸€è·¯å¾„ç”Ÿæˆ**ï¼šä½¿ç”¨ `getArticlePath` å·¥å…·å‡½æ•°
2. **æ›´æ–°ä¸­é—´ä»¶**ï¼šæ·»åŠ è‡ªåŠ¨é‡å®šå‘æˆ–é‡å†™é€»è¾‘  
3. **æ¸…ç†é…ç½®**ï¼šç§»é™¤ `esmExternals: 'loose'`

### éªŒè¯æˆåŠŸ
```bash
# é‡å¯æœåŠ¡å™¨
npm run dev:clean

# æµ‹è¯•è·¯ç”±
node test-routes.js

# æ‰‹åŠ¨è®¿é—®
open http://localhost:3001/en/articles/5-minute-period-pain-relief
```

## âœ… ä½ çš„åˆ†æè¯„ä»·

**å®Œå…¨æ­£ç¡®** âœ¨ ä½ çš„åˆ†ææŠ“ä½äº†é—®é¢˜çš„æ ¸å¿ƒï¼š
- âœ… è·¯å¾„ç¼ºå°‘ `/articles/` æ®µçš„å‘ç°å¾ˆç²¾å‡†
- âœ… æ§åˆ¶å°æˆªå›¾åˆ†æåˆ°ä½  
- âœ… ä¸­é—´ä»¶å¹²æ‰°çš„æ¨æµ‹åˆç†
- âœ… ä¿®å¤ä¼˜å…ˆçº§æ’åºæ°å½“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ **è·¯å¾„ç”Ÿæˆé€»è¾‘é”™è¯¯** + **åŠ¨æ€è·¯ç”±åŒ¹é…å¤±è´¥** çš„å¤åˆé—®é¢˜ï¼ŒæŒ‰ç…§ä¸Šè¿°æ–¹æ¡ˆæ‰§è¡Œååº”è¯¥èƒ½å½»åº•è§£å†³ã€‚




æ ¹æ®æˆ‘çš„åˆ†æï¼Œè®©æˆ‘æ€»ç»“ä¸€ä¸‹å½“å‰å­˜åœ¨çš„é—®é¢˜ã€èƒŒæ™¯ã€åŸå› åˆ†æå’Œå…·ä½“çš„ä¿®å¤æ–¹æ³•ï¼š


[1 tool called]

## é—®é¢˜æ€»ç»“æŠ¥å‘Š

### ï¿½ï¿½ å½“å‰å­˜åœ¨çš„é—®é¢˜

1. **ä¸»è¦é—®é¢˜**ï¼šè®¿é—® `http://localhost:3001/en/5-minute-period-pain-relief` è¿”å› 404 é”™è¯¯
2. **æ¬¡è¦é—®é¢˜**ï¼šNext.js 15.5.2 çš„ Webpack é…ç½®è­¦å‘Š
3. **å¼€å‘ä½“éªŒé—®é¢˜**ï¼šå¼€å‘æœåŠ¡å™¨å¯åŠ¨æ—¶çš„å¤šä¸ªè­¦å‘Šä¿¡æ¯

### ğŸ“‹ é—®é¢˜èƒŒæ™¯

- **é¡¹ç›®ç¯å¢ƒ**ï¼šNext.js 15.5.2 + next-intl å›½é™…åŒ–
- **è·¯ç”±ç»“æ„**ï¼š`app/[locale]/articles/[slug]/page.tsx` åŠ¨æ€è·¯ç”±
- **æ–‡ç« å†…å®¹**ï¼š`5-minute-period-pain-relief` æ–‡ç« æ–‡ä»¶å­˜åœ¨ä¸”å†…å®¹å®Œæ•´
- **æ„å»ºçŠ¶æ€**ï¼šç”Ÿäº§æ„å»ºæˆåŠŸï¼Œé™æ€ç”ŸæˆåŒ…å«è¯¥è·¯ç”±

### ï¿½ï¿½ åŸå› åˆ†æ

#### 1. è·¯ç”±åŒ¹é…é—®é¢˜
- **ç°è±¡**ï¼šå¼€å‘æ¨¡å¼ä¸‹è·¯ç”±è¿”å›404ï¼Œä½†ç”Ÿäº§æ„å»ºæˆåŠŸ
- **è¯æ®**ï¼šæ„å»ºè¾“å‡ºæ˜¾ç¤º `â”œ   â”œ /en/articles/5-minute-period-pain-relief` è¢«æ­£ç¡®ç”Ÿæˆ
- **æ¨æµ‹**ï¼šå¼€å‘æ¨¡å¼ä¸‹çš„åŠ¨æ€è·¯ç”±è§£æå­˜åœ¨é—®é¢˜

#### 2. ä¸­é—´ä»¶å¹²æ‰°
- **ç°è±¡**ï¼šå“åº”å¤´æ˜¾ç¤º `X-Middleware-Rewrite: /en/5-minute-period-pain-relief`
- **åˆ†æ**ï¼šä¸­é—´ä»¶æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œä½†å¯èƒ½æ²¡æœ‰æ­£ç¡®ä¼ é€’ç»™æ–‡ç« é¡µé¢ç»„ä»¶

#### 3. å›½é™…åŒ–é…ç½®å†²çª
- **ç°è±¡**ï¼š`next-intl` ä¸­é—´ä»¶ä¸ Next.js 15.5.2 å¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜
- **è¯æ®**ï¼šå…¶ä»–æ–‡ç« è·¯ç”±å·¥ä½œæ­£å¸¸ï¼Œä½†ç‰¹å®šslugå‡ºç°é—®é¢˜

#### 4. å¼€å‘æ¨¡å¼ç¼“å­˜é—®é¢˜
- **ç°è±¡**ï¼šæ¸…é™¤ `.next` ç¼“å­˜åé—®é¢˜ä»ç„¶å­˜åœ¨
- **åˆ†æ**ï¼šå¯èƒ½æ˜¯ Next.js 15.5.2 åœ¨å¼€å‘æ¨¡å¼ä¸‹çš„å·²çŸ¥é—®é¢˜

### ï¿½ï¿½ï¸ å…·ä½“ä¿®å¤æ–¹æ³•

#### æ–¹æ³•1ï¼šä¿®å¤ Next.js é…ç½®è­¦å‘Š
```javascript
// next.config.js ä¸­ç§»é™¤æœ‰é—®é¢˜çš„é…ç½®
const nextConfig = {
  experimental: {
    // ç§»é™¤è¿™è¡Œï¼Œå› ä¸ºå®ƒå¯èƒ½å¯¼è‡´æ¨¡å—è§£æé—®é¢˜
    // esmExternals: 'loose',
    optimizeCss: true,
    scrollRestoration: true,
    optimizePackageImports: ['next-intl', 'lucide-react'],
    optimizeServerReact: true,
  },
  // æ·»åŠ è¾“å‡ºæ–‡ä»¶è·Ÿè¸ªæ ¹ç›®å½•
  outputFileTracingRoot: path.join(__dirname, '../../'),
}
```

#### æ–¹æ³•2ï¼šä¼˜åŒ–ä¸­é—´ä»¶é…ç½®
```typescript
// middleware.ts ä¸­æ”¹è¿›è·¯ç”±å¤„ç†
export default function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // æ·»åŠ è°ƒè¯•æ—¥å¿—
  console.log('Middleware processing:', pathname);
  
  // ç¡®ä¿æ–‡ç« è·¯ç”±ä¸è¢«ä¸­é—´ä»¶å¹²æ‰°
  if (pathname.startsWith('/en/articles/') || pathname.startsWith('/zh/articles/')) {
    return intlMiddleware(request);
  }
  
  // å…¶ä»–ä¸­é—´ä»¶é€»è¾‘...
}
```

#### æ–¹æ³•3ï¼šä¿®å¤æ–‡ç« é¡µé¢ç»„ä»¶
```typescript
// app/[locale]/articles/[slug]/page.tsx
export default async function ArticlePage({ params }: { params: Promise<{ locale: Locale; slug: string }> }) {
  const { locale, slug } = await params;
  setRequestLocale(locale);

  // æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
  try {
    const article = await getArticleBySlug(slug, locale);
    if (!article) {
      console.error(`Article not found: ${slug} for locale: ${locale}`);
      notFound();
    }
    // å…¶ä½™ç»„ä»¶é€»è¾‘...
  } catch (error) {
    console.error('Error loading article:', error);
    notFound();
  }
}
```

#### æ–¹æ³•4ï¼šé™çº§ Next.js ç‰ˆæœ¬ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
```json
// package.json
{
  "dependencies": {
    "next": "^14.2.0"  // é™çº§åˆ°ç¨³å®šç‰ˆæœ¬
  }
}
```

#### æ–¹æ³•5ï¼šä½¿ç”¨é™æ€ç”Ÿæˆæ›¿ä»£åŠ¨æ€è·¯ç”±
```typescript
// åœ¨ generateStaticParams ä¸­ç¡®ä¿åŒ…å«æ‰€æœ‰æ–‡ç« 
export async function generateStaticParams() {
  const locales = ['en', 'zh'];
  const articles = await getAllArticles(); // åŠ¨æ€è·å–æ‰€æœ‰æ–‡ç« 
  
  return articles.flatMap(article => 
    locales.map(locale => ({
      locale,
      slug: article.slug
    }))
  );
}
```

### ğŸ¯ æ¨èä¿®å¤é¡ºåº

1. **ç«‹å³ä¿®å¤**ï¼šç§»é™¤ `next.config.js` ä¸­çš„ `esmExternals: 'loose'` é…ç½®
2. **çŸ­æœŸä¿®å¤**ï¼šä¼˜åŒ–ä¸­é—´ä»¶é€»è¾‘ï¼Œç¡®ä¿æ–‡ç« è·¯ç”±ä¸è¢«å¹²æ‰°
3. **ä¸­æœŸä¿®å¤**ï¼šæ”¹è¿›é”™è¯¯å¤„ç†å’Œè°ƒè¯•æ—¥å¿—
4. **é•¿æœŸè€ƒè™‘**ï¼šå¦‚æœé—®é¢˜æŒç»­ï¼Œè€ƒè™‘é™çº§ Next.js ç‰ˆæœ¬æˆ–ç­‰å¾…å®˜æ–¹ä¿®å¤

### ï¿½ï¿½ é—®é¢˜ä¼˜å…ˆçº§

- **é«˜ä¼˜å…ˆçº§**ï¼šè·¯ç”±404é—®é¢˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
- **ä¸­ä¼˜å…ˆçº§**ï¼šWebpacké…ç½®è­¦å‘Šï¼ˆå½±å“å¼€å‘ä½“éªŒï¼‰
- **ä½ä¼˜å…ˆçº§**ï¼šå¼€å‘æœåŠ¡å™¨è­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

è¿™ä¸ªåˆ†æåŸºäºæˆ‘çš„æ·±å…¥è°ƒè¯•å’Œæµ‹è¯•ï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› å¾ˆå¯èƒ½æ˜¯ Next.js 15.5.2 ä¸å½“å‰é¡¹ç›®é…ç½®çš„å…¼å®¹æ€§é—®é¢˜ã€‚